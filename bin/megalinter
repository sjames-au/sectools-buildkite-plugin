#!/bin/bash

set -euo pipefail

TAG=${MEGALINTER_IMAGE_VERSION:-latest}

echo "--- :docker: Fetching nvuillam/mega-linter:${TAG}"

docker pull "nvuillam/mega-linter:${TAG}"

echo "+++ Scanning with MegaLinter"

args=(
    "-v"
    "${PWD}:/tmp/lint"
    "-e" "ENABLE_LINTERS=ALL"
    "-e" "SHOW_ELAPSED_TIME=true"
    "-e" "PRINT_ALPACA=true"
    "-e" "REPORT_OUTPUT_FOLDER=/tmp/lint/report"
    "-e" "REPORT_OUTPUT_DETAIL=debug"
)

docker run "${args[@]}" nvuillam/mega-linter:"${TAG}"

echo "--- :buildkite: Uploading MegaLinter report to Buildkite"

buildkite-agent artifact upload "/tmp/lint/report/mega-linter-report.json"
